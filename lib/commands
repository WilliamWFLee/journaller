cmd_help() {
  cat <<- EOF
Syntax: $0 <subcommand> <args>

Possible subcommands:
  new       write a new entry
  read      read journal entries
  copy      copy the entire journal to another directory
  encrypt   encrypt any unencrypted entries
  config    configure journaller
  help      display this help
EOF
}

cmd_new() {
  local dir="$JOURNAL_DIR/$(current_date)"
  mkdir -p "$dir"

  local file="$dir/text.md"
  echo -ne "**$(current_time)**\n\n" >> "$file"
  vim "$file"

  if [[ "$@" == *"--encrypt"* ]]; then  
    encrypt
  fi
}

cmd_read() {
  local dir=$(get_entry_dir_from_date_text $1)

  if [[ -z $dir ]]; then
    log_error "Journal entry does not exist for $(echo $1 | path_to_date)"
    return 1
  fi

  log_info "Opening journal entry"
  log_info "Requesting passphrase to decrypt journal entry"
  read_passphrase 'Enter passphrase: '

  decrypt_dir $dir

  pandoc -f markdown -t html $dir/text.md > $dir/text.html
  open $dir/text.html 2> /dev/null

  log_info "Opening in browser, press <Return> to continue" && read
  log_info "Shredding decrypted files"

  shred_unencrypted_entry $dir
}

cmd_copy() {
  rsync -av --modify-window=1 --times --inplace "$(echo $JOURNAL_DIR | sed 's/\/$//g')" "$1"
}

cmd_encrypt() {
  log_info "Encrypting journal..."

  new_passphrase
  case $? in
  1)
    log_error "Passphrase is empty" > /dev/stderr
    return 1
    ;;
  2)
    log_error "Passphrases do not match" > /dev/stderr
    return 1
    ;;
  esac

  local file
  for file in $JOURNAL_DIR/**/!(*.gpg); do
    if [[ -f "$file" && ! -f "$file.gpg" ]]; then 
      log_info "Encrypting and shredding $file" 
      encrypt_file "$file" "$PASSPHRASE" && shred_file $file
    fi
  done
}

cmd_config() {
  case $1 in
  new)
    if create_config_file; then
      log_info "~/.journallerrc created"
    else
      log_info "~/.journallerrc already exists"
    fi
    ;;
  *)
    local config_key="$1"
    local config_value="$2"
    if [[ -z "$config_value" ]]; then
      get_config_key "$config_key"
    else
      set_config_key "$config_key" "$config_value"
    fi
  esac
}
