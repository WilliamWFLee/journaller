#!/bin/bash

. "$(dirname $0)/../lib/logging"

shopt -s extglob globstar

read -rsp 'Enter passphrase: ' PASSPHRASE; echo
if [[ -z "${PASSPHRASE}" ]]; then
  echo -e "$ERROR Passphrase is empty" > /dev/stderr
  exit 1
fi

read -rsp 'Confirm passphrase: ' PASSPHRASE_CONFIRMATION; echo

if [[ "${PASSPHRASE}" != "${PASSPHRASE_CONFIRMATION}" ]]; then
  echo -e "$ERROR Passphrases do not match" > /dev/stderr
  exit 1
fi

for file in $1/**/!(*.gpg); do
  if [[ -f $file ]] && [[ ! -f "$file.gpg" ]]; then 
    encrypt-and-shred "$file" "$PASSPHRASE"
  fi
done
